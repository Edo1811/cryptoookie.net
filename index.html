<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>$COOKIE - Totally Real Crypto</title>
  <style>
    :root{
      --cookie: #ffcc66;
      --cookie-hover:#ffb84d;
      --cookie-deep:#cc6600;
      --ink:#333;
      --bg:#fffaf0;
      --line:#ddd;
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background-color: var(--bg);
      color: var(--ink);
      text-align: center;
      padding: 50px 20px;
    }

    h1 { font-size: 2.5rem; margin-bottom: 10px; }
    .price { font-size: 2rem; margin-bottom: 20px; }
    .wallet { font-size: 1.1rem; margin-bottom: 30px; }

    /* --- Actions row --- */
    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .btn {
      padding: 10px 18px;
      font-size: 1.05rem;
      border: none;
      border-radius: 10px;
      background-color: var(--cookie);
      color: #000;
      cursor: pointer;
      transition: transform .06s ease, background-color .15s ease, box-shadow .15s ease;
      box-shadow: 0 1px 0 rgba(0,0,0,.05), 0 2px 10px rgba(0,0,0,.05);
    }
    .btn:hover { background-color: var(--cookie-hover); }
    .btn:active { transform: translateY(1px); }
    .btn[disabled]{
      opacity: .55;
      cursor: not-allowed;
      filter: grayscale(.1);
      box-shadow: none;
    }

    /* --- Styled dropdown that looks like a button --- */
    .select-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 10px;
      background: var(--cookie);
      box-shadow: 0 1px 0 rgba(0,0,0,.05), 0 2px 10px rgba(0,0,0,.05);
      transition: background-color .15s ease;
    }
    .select-wrap:hover { background: var(--cookie-hover); }
    .select-wrap:focus-within { outline: 2px solid #ff9900; outline-offset: 2px; }

    .select-wrap label {
      font-size: .95rem;
      color: #000;
      opacity: .8;
      user-select: none;
    }

    .select-wrap select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      border: none;
      background: transparent;
      font: inherit;
      color: #000;
      padding-right: 22px; /* room for arrow */
      cursor: pointer;
      outline: none;
    }

    /* custom arrow */
    .select-wrap::after{
      content:"";
      position:absolute;
      right:12px;
      width:12px; height:12px;
      pointer-events:none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="%23000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
      background-size: 12px 12px;
      background-repeat:no-repeat;
      opacity:.8;
    }

    #graph {
      margin-top: 40px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background-color: #fff;
    }

    table {
      margin-top: 30px;
      border-collapse: collapse;
      margin-left: auto;
      margin-right: auto;
      min-width: 420px;
      max-width: 90vw;
    }

    th, td {
      padding: 8px 12px;
      border-bottom: 1px solid #ccc;
    }

    p.description {
      max-width: 600px;
      margin: 20px auto;
      font-size: 0.95rem;
      color: #444;
    }
  </style>
</head>
<body>

  <h1>$COOKIE Exchange</h1>
  <div class="price">Current $COOKIE price: <span id="price">$100.00</span></div>
  <div class="wallet">
    üíµ Balance: $<span id="balance">500.00</span><br>
    üç™ You own: <span id="cookies">0</span> $COOKIEs
  </div>

  <!-- Single selector + two buttons -->
  <div class="actions">
    <div class="select-wrap" role="group" aria-label="Quantity selector">
      <label for="qtySelect">Qty</label>
      <select id="qtySelect">
        <option value="1">1√ó</option>
        <option value="10">10√ó</option>
        <option value="100">100√ó</option>
        <option value="1000">1000√ó</option>
        <option value="max">Max</option>
      </select>
    </div>

    <button id="buyBtn" class="btn" onclick="buySelected()">Buy</button>
    <button id="sellBtn" class="btn" onclick="sellSelected()">Sell</button>
  </div>

  <canvas id="graph" width="600" height="200"></canvas>

  <p class="description">
    <strong>What is $COOKIE?</strong><br>
    $COOKIE is a 100% fake cryptocurrency backed by ‚ú®vibes‚ú®, emotional damage, and the occasional burnt toaster strudel. Its value fluctuates based on quantum crumbs, moon phases, and how many ducks are swimming in a triangle formation. Do not invest with real money or brain cells.
  </p>

  <h2>üç™ Wallet History</h2>
  <table id="walletTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Amount</th>
        <th>Price per $COOKIE</th>
        <th>Total Spent</th>
      </tr>
    </thead>
    <tbody id="walletBody">
      <!-- Purchases show up here -->
    </tbody>
  </table>

  <script>
    let balance = 500.00;
    let cookies = 0;
    let price = 100.00;
    let priceHistory = [price];
    let wallet = [];
    const PRICE_MIN = 10;
    const PRICE_MAX = 1000;
    let logAnchor = Math.log(price); // the moving target the price reverts to



    const priceEl = document.getElementById("price");
    const balanceEl = document.getElementById("balance");
    const cookiesEl = document.getElementById("cookies");
    const canvas = document.getElementById("graph");
    const ctx = canvas.getContext("2d");
    const walletBody = document.getElementById("walletBody");
    const qtySelect = document.getElementById("qtySelect");
    const buyBtn = document.getElementById("buyBtn");
    const sellBtn = document.getElementById("sellBtn");

    function updateDisplay() {
      priceEl.textContent = `$${price.toFixed(2)}`;
      balanceEl.textContent = balance.toFixed(2);
      cookiesEl.textContent = cookies.toFixed(4);
      updateActionState();
    }

    function fluctuatePrice() {
  // --- Mean-reverting to a MOVING anchor in log space ---
  const logMin = Math.log(PRICE_MIN);
  const logMax = Math.log(PRICE_MAX);
  const logRange = logMax - logMin;

  let logP = Math.log(price);

  // Position 0..1 within the band (for edge-aware noise)
  const pos = (logP - logMin) / logRange;

  // Tunables (balanced for 10‚Äì1000 range)
  const K         = 0.07;   // strength toward anchor (lower = looser)
  const SIGMA     = 0.035;  // base noise for price (percent-ish, calm)
  const EDGE_GAIN = 0.6;    // extra noise near edges to avoid sticking

  const ALPHA     = 0.015;  // how fast anchor follows price (EMA)
  const SIGMA_A   = 0.01;  // tiny anchor wander (lets the center drift)

  // Two independent normals via Box‚ÄìMuller
  const u1 = Math.random() || 1e-9, u2 = Math.random();
  const z  = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2); // price noise

  const u3 = Math.random() || 1e-9, u4 = Math.random();
  const zA = Math.sqrt(-2 * Math.log(u3)) * Math.cos(2 * Math.PI * u4); // anchor noise

  // Update the anchor (EMA of log-price + tiny random walk), with margins
  const margin = 0.08 * logRange; // keep anchor off the hard edges
  logAnchor = (1 - ALPHA) * logAnchor + ALPHA * logP + zA * SIGMA_A;
  if (logAnchor < logMin + margin) logAnchor = logMin + margin;
  if (logAnchor > logMax - margin) logAnchor = logMax - margin;

  // Edge-aware volatility: slightly higher near edges, calmer in the middle
  const edgeFactor = 1 + EDGE_GAIN * (Math.abs(pos - 0.5) / 0.5); // 1..(1+EDGE_GAIN)
  const sigmaEff = SIGMA * edgeFactor;

  // Mean reversion toward the MOVING anchor + gentle noise
  logP += K * (logAnchor - logP) + z * sigmaEff;

  // Soft reflection at band edges (prevents glueing)
  if (logP < logMin) logP = logMin + (logMin - logP) * 0.25;
  if (logP > logMax) logP = logMax - (logP - logMax) * 0.25;

  price = Math.exp(logP);

  // record + redraw
  priceHistory.push(price);
  if (priceHistory.length > 60) priceHistory.shift();
  updateDisplay();
  drawGraph();
}



    function buyCookie(amount = 1) {
      if (amount <= 0) return;
      const cost = price * amount;
      if (balance >= cost) {
        balance -= cost;
        cookies += amount;
        wallet.push({ amount, priceAtPurchase: price, total: cost });
        renderWallet();
        updateDisplay();
      }
    }

    function sellCookie(amount = 1) {
      if (amount <= 0) return;
      if (cookies >= amount) {
        let toSell = amount;
        let i = 0;
        while (toSell > 0 && i < wallet.length) {
          const entry = wallet[i];
          if (entry.amount <= toSell) {
            balance += entry.amount * price;
            toSell -= entry.amount;
            wallet.splice(i, 1);
          } else {
            balance += toSell * price;
            entry.amount -= toSell;
            entry.total = entry.amount * entry.priceAtPurchase;
            toSell = 0;
            i++;
          }
        }
        cookies -= amount;
        if (cookies < 0) cookies = 0;
        updateDisplay();
        renderWallet();
      }
    }

    function drawGraph() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const maxPrice = Math.max(...priceHistory);
      const minPrice = Math.min(...priceHistory);
      const range = (maxPrice - minPrice) || 1; // avoid divide-by-zero

      ctx.beginPath();
      for (let i = 0; i < priceHistory.length; i++) {
        const x = (i / (priceHistory.length - 1)) * canvas.width;
        const y = canvas.height - ((priceHistory[i] - minPrice) / range) * canvas.height;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "#ff9900";
      ctx.lineWidth = 2;
      ctx.stroke();

      // last point
      const lastX = canvas.width;
      const lastY = canvas.height - ((price - minPrice) / range) * canvas.height;
      ctx.fillStyle = "#cc6600";
      ctx.beginPath();
      ctx.arc(lastX - 2, lastY, 4, 0, 2 * Math.PI);
      ctx.fill();
    }

    function renderWallet() {
      walletBody.innerHTML = "";
      wallet.forEach((entry, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${entry.amount}</td>
          <td>$${entry.priceAtPurchase.toFixed(2)}</td>
          <td>$${entry.total.toFixed(2)}</td>
        `;
        walletBody.appendChild(row);
      });
    }

    // -------- Selector-powered actions ----------
    function getSelectedAmount() {
      const v = qtySelect.value;
      if (v === "max") return "max";
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 1;
    }

    function updateActionState(){
      const sel = getSelectedAmount();
      const maxAffordable = Math.floor(balance / price);

      // Update button labels
      buyBtn.textContent  = `Buy ${sel === "max" ? "Max" : sel + "√ó"}`;
      sellBtn.textContent = `Sell ${sel === "max" ? "All" : sel + "√ó"}`;

      // Enable/disable based on feasibility
      const buyDisabled  = sel === "max" ? (maxAffordable === 0) : (balance < price * sel);
      const sellDisabled = sel === "max" ? (cookies <= 0)        : (cookies < sel);

      buyBtn.disabled  = buyDisabled;
      sellBtn.disabled = sellDisabled;
    }

    function buySelected() {
      const sel = getSelectedAmount();
      if (sel === "max") {
        const maxAffordable = Math.floor(balance / price);
        if (maxAffordable > 0) buyCookie(maxAffordable);
        return;
      }
      buyCookie(sel);
    }

    function sellSelected() {
      const sel = getSelectedAmount();
      if (sel === "max") {
        sellCookie(cookies);
        return;
      }
      const amt = Math.min(sel, cookies);
      if (amt > 0) sellCookie(amt);
    }

    qtySelect.addEventListener("change", updateActionState);
    // -------------------------------------------

    setInterval(fluctuatePrice, 1500);
    updateDisplay();
    drawGraph();
  </script>

</body>
</html>
